- name: Install jq
  apt: name=jq state=latest update_cache=yes

- name: Copy docker-compose file
  copy:
    src: ../files/docker-compose.yml
    dest: ./

- name: Get mnemonic
  command: "awk 'NR == 2 {print $1}' RS='`' FS='`' ./aura"
  register: mnemonic

- name: Creating .env file
  copy:
    dest: "./.env"
    content: |
      SEALER_NUMBER={{sealer_number}}
      NODE_IMAGE={{node_image}}
      CLIENT_IMAGE={{client_image}}
      SEALER_MNEMONIC="{{mnemonic.stdout}}"

- name: Docker Login
  become: true
  shell:
    cmd: "docker login {{docker_registry}} -u {{docker_registry_username}} -p {{docker_registry_password}}"

- name: Get aura key
  command: "awk 'NR == 2 {print $1}' RS='SS58 Address:      ' FS='\n' ./aura"
  register: auraPublicKey

- name: Get grandpa key
  command: "awk 'NR == 2 {print $1}' RS='SS58 Address:      ' FS='\n' ./grandpa"
  register: grandpaPublicKey

- name: save aura public key
  become: true
  local_action: "shell echo {{auraPublicKey.stdout}} > ./roles/provotum-v3-mn-server-inst/files/sealer{{sealer_number}}"

- name: save grandpa public key
  become: true
  local_action: "shell echo {{grandpaPublicKey.stdout}} >> ./roles/provotum-v3-mn-server-inst/files/sealer{{sealer_number}}"
